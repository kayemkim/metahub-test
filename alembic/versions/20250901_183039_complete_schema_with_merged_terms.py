"""Complete MetaHub Schema with Merged Term Tables (2025-09-01)

Revision ID: 92e72b944d58
Revises: 
Create Date: 2025-09-01 18:30:39.927109

Complete database schema including all optimizations:
- Taxonomy management: tx_taxonomy, tx_term (with integrated content), tx_term_version
- Codeset management: cm_codeset, cm_code, cm_code_version
- Meta type system: custom_meta_group, custom_meta_item (with direct type_kind)
- Meta value system: custom_meta_value, custom_meta_value_version (with unified JSON)

Schema improvements:
✅ Term tables merged: tx_term + tx_term_content → tx_term (2-table structure)
✅ Direct relationships: tx_term → tx_term_version (no intermediate table)
✅ Unified meta values: Single value_json column with enriched data
✅ Code-based meta types: MetaTypeKind enum in app/core/meta_types.py
✅ Spring @Transactional style transaction management

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '92e72b944d58'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('cm_codeset',
    sa.Column('codeset_id', sa.String(length=36), nullable=False),
    sa.Column('codeset_code', sa.String(length=100), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('codeset_id'),
    sa.UniqueConstraint('codeset_code')
    )
    op.create_table('custom_meta_group',
    sa.Column('group_id', sa.String(length=36), nullable=False),
    sa.Column('group_code', sa.String(length=100), nullable=False),
    sa.Column('display_name', sa.String(length=200), nullable=False),
    sa.Column('sort_order', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('group_id'),
    sa.UniqueConstraint('group_code')
    )
    op.create_table('tx_taxonomy',
    sa.Column('taxonomy_id', sa.String(length=36), nullable=False),
    sa.Column('taxonomy_code', sa.String(length=100), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('taxonomy_id'),
    sa.UniqueConstraint('taxonomy_code')
    )
    op.create_table('cm_code',
    sa.Column('code_id', sa.String(length=36), nullable=False),
    sa.Column('codeset_id', sa.String(length=36), nullable=False),
    sa.Column('code_key', sa.String(length=150), nullable=False),
    sa.Column('current_version_id', sa.String(length=36), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['codeset_id'], ['cm_codeset.codeset_id'], ),
    sa.PrimaryKeyConstraint('code_id'),
    sa.UniqueConstraint('codeset_id', 'code_key', name='uq_code_key_per_set')
    )
    op.create_table('custom_meta_item',
    sa.Column('item_id', sa.String(length=36), nullable=False),
    sa.Column('item_code', sa.String(length=150), nullable=False),
    sa.Column('display_name', sa.String(length=200), nullable=False),
    sa.Column('group_id', sa.String(length=36), nullable=False),
    sa.Column('type_kind', sa.String(length=30), nullable=False),
    sa.Column('is_required', sa.Boolean(), nullable=False),
    sa.Column('default_json', sa.Text(), nullable=True),
    sa.Column('selection_mode', sa.String(length=10), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['group_id'], ['custom_meta_group.group_id'], ),
    sa.PrimaryKeyConstraint('item_id'),
    sa.UniqueConstraint('item_code')
    )
    op.create_table('tx_term',
    sa.Column('term_id', sa.String(length=36), nullable=False),
    sa.Column('taxonomy_id', sa.String(length=36), nullable=False),
    sa.Column('term_key', sa.String(length=150), nullable=False),
    sa.Column('display_name', sa.String(length=200), nullable=False),
    sa.Column('parent_term_id', sa.String(length=36), nullable=True),
    sa.Column('current_version_id', sa.String(length=36), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['parent_term_id'], ['tx_term.term_id'], ),
    sa.ForeignKeyConstraint(['taxonomy_id'], ['tx_taxonomy.taxonomy_id'], ),
    sa.PrimaryKeyConstraint('term_id'),
    sa.UniqueConstraint('taxonomy_id', 'term_key', name='uq_term_key_per_taxonomy')
    )
    op.create_index(op.f('ix_tx_term_parent_term_id'), 'tx_term', ['parent_term_id'], unique=False)
    op.create_index(op.f('ix_tx_term_taxonomy_id'), 'tx_term', ['taxonomy_id'], unique=False)
    op.create_table('cm_code_version',
    sa.Column('code_version_id', sa.String(length=36), nullable=False),
    sa.Column('code_id', sa.String(length=36), nullable=False),
    sa.Column('version_no', sa.Integer(), nullable=False),
    sa.Column('label_default', sa.String(length=200), nullable=False),
    sa.Column('sort_order', sa.Integer(), nullable=False),
    sa.Column('parent_code_id', sa.String(length=36), nullable=True),
    sa.Column('valid_from', sa.DateTime(timezone=True), nullable=False),
    sa.Column('valid_to', sa.DateTime(timezone=True), nullable=True),
    sa.Column('tx_time', sa.DateTime(timezone=True), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('extra_json', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['code_id'], ['cm_code.code_id'], ),
    sa.ForeignKeyConstraint(['parent_code_id'], ['cm_code.code_id'], ),
    sa.PrimaryKeyConstraint('code_version_id'),
    sa.UniqueConstraint('code_id', 'version_no', name='uq_code_version_no')
    )
    op.create_index(op.f('ix_cm_code_version_code_id'), 'cm_code_version', ['code_id'], unique=False)
    op.create_table('custom_meta_value',
    sa.Column('value_id', sa.String(length=36), nullable=False),
    sa.Column('target_type', sa.String(length=50), nullable=False),
    sa.Column('target_id', sa.String(length=200), nullable=False),
    sa.Column('item_id', sa.String(length=36), nullable=False),
    sa.Column('current_version_id', sa.String(length=36), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['item_id'], ['custom_meta_item.item_id'], ),
    sa.PrimaryKeyConstraint('value_id'),
    sa.UniqueConstraint('target_type', 'target_id', 'item_id', name='uq_value_target_item')
    )
    op.create_index('ix_value_target', 'custom_meta_value', ['target_type', 'target_id'], unique=False)
    op.create_table('tx_term_version',
    sa.Column('version_id', sa.String(length=36), nullable=False),
    sa.Column('term_id', sa.String(length=36), nullable=False),
    sa.Column('version_no', sa.Integer(), nullable=False),
    sa.Column('body_json', sa.Text(), nullable=True),
    sa.Column('body_markdown', sa.Text(), nullable=True),
    sa.Column('valid_from', sa.DateTime(timezone=True), nullable=False),
    sa.Column('valid_to', sa.DateTime(timezone=True), nullable=True),
    sa.Column('author', sa.String(length=200), nullable=True),
    sa.Column('change_reason', sa.String(length=1000), nullable=True),
    sa.ForeignKeyConstraint(['term_id'], ['tx_term.term_id'], ),
    sa.PrimaryKeyConstraint('version_id'),
    sa.UniqueConstraint('term_id', 'version_no', name='uq_term_version_no')
    )
    op.create_index(op.f('ix_tx_term_version_term_id'), 'tx_term_version', ['term_id'], unique=False)
    op.create_table('custom_meta_value_version',
    sa.Column('version_id', sa.String(length=36), nullable=False),
    sa.Column('value_id', sa.String(length=36), nullable=False),
    sa.Column('version_no', sa.Integer(), nullable=False),
    sa.Column('value_json', sa.Text(), nullable=True),
    sa.Column('valid_from', sa.DateTime(timezone=True), nullable=False),
    sa.Column('valid_to', sa.DateTime(timezone=True), nullable=True),
    sa.Column('tx_time', sa.DateTime(timezone=True), nullable=False),
    sa.Column('author', sa.String(length=200), nullable=True),
    sa.Column('reason', sa.String(length=1000), nullable=True),
    sa.ForeignKeyConstraint(['value_id'], ['custom_meta_value.value_id'], ),
    sa.PrimaryKeyConstraint('version_id'),
    sa.UniqueConstraint('value_id', 'version_no', name='uq_value_version_no')
    )
    op.create_index(op.f('ix_custom_meta_value_version_value_id'), 'custom_meta_value_version', ['value_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_custom_meta_value_version_value_id'), table_name='custom_meta_value_version')
    op.drop_table('custom_meta_value_version')
    op.drop_index(op.f('ix_tx_term_version_term_id'), table_name='tx_term_version')
    op.drop_table('tx_term_version')
    op.drop_index('ix_value_target', table_name='custom_meta_value')
    op.drop_table('custom_meta_value')
    op.drop_index(op.f('ix_cm_code_version_code_id'), table_name='cm_code_version')
    op.drop_table('cm_code_version')
    op.drop_index(op.f('ix_tx_term_taxonomy_id'), table_name='tx_term')
    op.drop_index(op.f('ix_tx_term_parent_term_id'), table_name='tx_term')
    op.drop_table('tx_term')
    op.drop_table('custom_meta_item')
    op.drop_table('cm_code')
    op.drop_table('tx_taxonomy')
    op.drop_table('custom_meta_group')
    op.drop_table('cm_codeset')
    # ### end Alembic commands ###
